{
  "widget": {
    "isSystemType": false,
    "bundleAlias": "gestion_du_parc",
    "typeAlias": "ajouter_un_utilisateur_v2",
    "type": "static",
    "title": "New widget",
    "image": null,
    "description": null,
    "sizeX": 7.5,
    "sizeY": 3,
    "config": {
      "datasources": [],
      "timewindow": {
        "realtime": {
          "timewindowMs": 60000
        }
      },
      "showTitle": false,
      "backgroundColor": "rgb(255, 255, 255)",
      "color": "rgba(0, 0, 0, 0.87)",
      "padding": "8px",
      "settings": {
        "cardHtml": "<div class='card'>\n    <div class='content' id=\"Ajouter un nouvel utilisateur\">\n        <div class='column' id=\"Ajouter un nouvel utilisateur\" >\n            \n            <div class='value'>\n               <h1 id=\"Ajouter un nouvel utilisateur\">Ajouter un utilisateur</h1>\n            </div>    \n           \n        </div>\n        <img id=\"Ajouter un nouvel utilisateur\" height=\"80px\" src=\"data:image/png;base64,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\"/>\n    </div>\n</div>",
        "cardCss": ".card {\n   width: 100%;\n   height: 100%;\n   border: 2px solid #ccc;\n   box-sizing: border-box;\n}\n\n.card .content {\n   padding: 20px;\n   display: flex;\n   flex-direction: row;\n   align-items: center;\n   justify-content: space-around;\n   height: 100%;\n   box-sizing: border-box;\n}\n\n.card .content .column {\n   display: flex;\n   flex-direction: column;    \n   justify-content: space-around;\n   height: 100%;\n}\n\n.card h1 {\n    text-transform: uppercase;\n    color: #005EA8DE;\n    font-size: 20px;\n    font-weight: bold;\n    margin: 0;\n    padding-bottom: 10px;\n    line-height: 32px;\n}\n\n.card .value {\n    font-size: 38px;\n    font-weight: 200;\n}\n\n.card .description {\n    font-size: 20px;\n    color: #999;\n}"
      },
      "title": "New Ajouter un utilisateur v2",
      "dropShadow": true,
      "actions": {
        "elementClick": [
          {
            "name": "Ajouter un nouvel utilisateur",
            "icon": "more_horiz",
            "type": "customPretty",
            "customHtml": "<form #addEntityForm=\"ngForm\" [formGroup]=\"addEntityFormGroup\"\r\n      (ngSubmit)=\"save()\" class=\"add-entity-form\" style=\"width: 480px;\">\r\n    <mat-toolbar fxLayout=\"row\" color=\"primary\">\r\n        <h2>Ajouter utilisateur</h2>\r\n        <span fxFlex></span>\r\n        <button mat-icon-button (click)=\"cancel()\" type=\"button\">\r\n            <mat-icon class=\"material-icons\">close</mat-icon>\r\n        </button>\r\n    </mat-toolbar>\r\n    <mat-progress-bar color=\"warn\" mode=\"indeterminate\" *ngIf=\"isLoading$ | async\">\r\n    </mat-progress-bar>\r\n    <div style=\"height: 4px;\" *ngIf=\"!(isLoading$ | async)\"></div>\r\n    <div mat-dialog-content fxLayout=\"column\">\r\n        <mat-form-field class=\"mat-block\">\r\n            <mat-label>Nom de l'utilisateur</mat-label>\r\n            <input matInput formControlName=\"userLastName\" required>\r\n            <mat-error *ngIf=\"addEntityFormGroup.get('userLastName').hasError('required')\">\r\n                Le nom est requis.\r\n                </mat-error>\r\n        </mat-form-field>\r\n        <mat-form-field class=\"mat-block\">\r\n            <mat-label>Prénom de l'utilisateur</mat-label>\r\n            <input matInput formControlName=\"userFirstName\" required>\r\n            <mat-error *ngIf=\"addEntityFormGroup.get('userFirstName').hasError('required')\">\r\n                Le prénom est requis.\r\n            </mat-error>\r\n        </mat-form-field>\r\n        <mat-form-field class=\"mat-block\">\r\n            <mat-label>Numéro de téléphone de l'utilisateur</mat-label>\r\n            <input matInput formControlName=\"userPhoneNumber\" type=\"tel\">\r\n        </mat-form-field>\r\n        <mat-form-field class=\"mat-block\">\r\n            <mat-label>Adresse mail de l'utilisateur</mat-label>\r\n            <input matInput formControlName=\"userEmail\" type=\"email\" required>\r\n            <mat-error *ngIf=\"addEntityFormGroup.get('userEmail').hasError('required')\">\r\n                L'adresse mail est requise.\r\n            </mat-error>\r\n        </mat-form-field>\r\n        <mat-form-field>\r\n            <mat-label>Groupes d'utilisateurs</mat-label>\r\n            <mat-select formControlName=\"selectedUserGroups\" multiple>\r\n                <mat-option *ngFor=\"let userGroup of userGroupsList\" [value]=\"userGroup\">{{userGroup.name}}</mat-option>\r\n            </mat-select>\r\n            <mat-error *ngIf=\"addEntityFormGroup.get('selectedUserGroups').hasError('required')\">\r\n            Le groupe d'utilisateurs est requis.\r\n            </mat-error>\r\n        </mat-form-field>\r\n    </div>\r\n    <div mat-dialog-actions fxLayout=\"row\" fxLayoutAlign=\"end center\">\r\n        <button mat-button mat-raised-button color=\"primary\"\r\n            type=\"submit\"\r\n            [disabled]=\"(isLoading$ | async) || addEntityFormGroup.invalid || !addEntityFormGroup.dirty\">\r\n        Créer\r\n        </button>\r\n        <button mat-button color=\"primary\"\r\n                style=\"margin-right: 20px;\"\r\n                type=\"button\"\r\n                [disabled]=\"(isLoading$ | async)\"\r\n                (click)=\"cancel()\" cdkFocusInitial>\r\n        Annuler\r\n        </button>\r\n    </div>\r\n</form>",
            "customCss": "/*=======================================================================*/\n/*==========  There are two examples: for edit and add entity  ==========*/\n/*=======================================================================*/\n/*========================  Edit entity example  ========================*/\n/*=======================================================================*/\n/*\n.edit-entity-form .boolean-value-input {\n    padding-left: 5px;\n}\n\n.edit-entity-form .boolean-value-input .checkbox-label {\n    margin-bottom: 8px;\n    color: rgba(0,0,0,0.54);\n    font-size: 12px;\n}\n\n.relations-list .header {\n    padding-right: 5px;\n    padding-bottom: 5px;\n    padding-left: 5px;\n}\n\n.relations-list .header .cell {\n    padding-right: 5px;\n    padding-left: 5px;\n    font-size: 12px;\n    font-weight: 700;\n    color: rgba(0, 0, 0, .54);\n    white-space: nowrap;\n}\n\n.relations-list .mat-form-field-infix {\n    width: auto !important;\n}\n\n.relations-list .body {\n    padding-right: 5px;\n    padding-bottom: 15px;\n    padding-left: 5px;\n}\n\n.relations-list .body .row {\n    padding-top: 5px;\n}\n\n.relations-list .body .cell {\n    padding-right: 5px;\n    padding-left: 5px;\n}\n\n.relations-list .body .md-button {\n    margin: 0;\n}\n*/\n/*========================================================================*/\n/*=========================  Add entity example  =========================*/\n/*========================================================================*/\n/*\n.add-entity-form .boolean-value-input {\n    padding-left: 5px;\n}\n\n.add-entity-form .boolean-value-input .checkbox-label {\n    margin-bottom: 8px;\n    color: rgba(0,0,0,0.54);\n    font-size: 12px;\n}\n\n.relations-list .header {\n    padding-right: 5px;\n    padding-bottom: 5px;\n    padding-left: 5px;\n}\n\n.relations-list .header .cell {\n    padding-right: 5px;\n    padding-left: 5px;\n    font-size: 12px;\n    font-weight: 700;\n    color: rgba(0, 0, 0, .54);\n    white-space: nowrap;\n}\n\n.relations-list .mat-form-field-infix {\n    width: auto !important;\n}\n\n.relations-list .body {\n    padding-right: 5px;\n    padding-bottom: 15px;\n    padding-left: 5px;\n}\n\n.relations-list .body .row {\n    padding-top: 5px;\n}\n\n.relations-list .body .cell {\n    padding-right: 5px;\n    padding-left: 5px;\n}\n\n.relations-list .body .md-button {\n    margin: 0;\n}\n*/\n",
            "customFunction": "let $injector = widgetContext.$scope.$injector;\r\nlet customDialog = $injector.get(widgetContext.servicesMap.get('customDialog'));\r\nlet entityService = $injector.get(widgetContext.servicesMap.get('entityService'));\r\nlet assetService = $injector.get(widgetContext.servicesMap.get('assetService'));\r\nlet deviceService = $injector.get(widgetContext.servicesMap.get('deviceService'));\r\nlet attributeService = $injector.get(widgetContext.servicesMap.get('attributeService'));\r\nlet entityRelationService = $injector.get(widgetContext.servicesMap.get('entityRelationService'));\r\nlet entityGroupService = $injector.get(widgetContext.servicesMap.get('entityGroupService'));\r\nlet userService = $injector.get(widgetContext.servicesMap.get('userService'));\r\nlet dashboardService = $injector.get(widgetContext.servicesMap.get('dashboardService'));\r\n\r\nconst currentUser = widgetContext.$scope.currentUser;\r\nconst currentOwnerInfo = getCurrentOwnerInfo();\r\n\r\n// La classe Entity permettra de créer l'objet \"t\" utilisé dans les requêtes de recherche d'entités\r\nclass PageLink {\r\n  \r\n    constructor(pageSize, page, textSearch, sortOrder) {\r\n      this.textSearch = textSearch;\r\n      this.pageSize = pageSize;\r\n      this.page = page;\r\n      this.sortOrder = sortOrder;\r\n    }\r\n  \r\n    nextPageLink() {\r\n      return new PageLink(this.pageSize, this.page + 1, this.textSearch, this.sortOrder);\r\n    }\r\n  \r\n    toQuery() {\r\n      let query = `?pageSize=${this.pageSize}&page=${this.page}`;\r\n      if (this.textSearch && this.textSearch.length) {\r\n        query += `&textSearch=${this.textSearch}`;\r\n      }\r\n      if (this.sortOrder) {\r\n        query += `&sortProperty=${this.sortOrder.property}&sortOrder=${this.sortOrder.direction}`;\r\n      }\r\n      return query;\r\n    }\r\n}\r\n\r\n// ************************************* INITIALISATION *************************************\r\n\r\nopenAddEntityDialog();\r\n\r\nfunction openAddEntityDialog() {\r\n    customDialog.customDialog(htmlTemplate, AddEntityDialogController).subscribe();\r\n}\r\n\r\n// ************************************* LOGGED IN USER INFO *************************************\r\n\r\nfunction getCurrentOwnerInfo(){\r\n    let currentOwnerInfo = { \"type\": \"CUSTOMER\", \"id\": currentUser.customerId};\r\n    if(currentUser.authority === \"TENANT_ADMIN\"){\r\n        currentOwnerInfo = { \"type\": \"TENANT\", \"id\": currentUser.tenantId };\r\n    }\r\n    return currentOwnerInfo;\r\n}\r\n\r\n// ************************************* GET GROUP ALL ENTITIES *************************************\r\n\r\nfunction getGroupAllEntities(entityType) {\r\n    let entityArray = [];\r\n    entityGroupService.getEntityGroupAllByOwnerId(currentOwnerInfo.type, currentOwnerInfo.id, entityType)\r\n        .subscribe((entityGroupAllInfo) => { \r\n            const t = new PageLink(10000, 0, null, null);\r\n            entityGroupService.getEntityGroupEntities(entityGroupAllInfo.id.id, t)\r\n                .subscribe((entityList) => {\r\n                    entityList.data.forEach(element => {\r\n                        entityArray.push(element);\r\n                    });\r\n                });\r\n        });\r\n    return entityArray;\r\n}\r\n\r\n// ************************************* FORMULAIRE *************************************\r\n\r\nfunction AddEntityDialogController(instance) {\r\n    let vm = instance;\r\n    vm.addEntityFormGroup = vm.fb.group({\r\n        userLastName: ['', [vm.validators.required]],\r\n        userFirstName: ['', [vm.validators.required]],\r\n        userEmail: ['', [vm.validators.pattern(\"^[a-z0-9._%+-]+@[a-z0-9.-]+\\\\.[a-z]{2,4}$\")]],\r\n        userPhoneNumber: [''],\r\n        selectedUserGroups: ['', [vm.validators.required]],\r\n        userGroupsList: ['']\r\n    });\r\n\r\n    vm.cancel = function() {\r\n        vm.dialogRef.close(null);\r\n    };\r\n\r\n    function getClientsUserGroups(userGroupList){\r\n        let results = [];\r\n        userGroupList.forEach(userGroup => {\r\n            if(userGroup.name.slice(0, 7) === \"Clients\"){\r\n                attributeService.getEntityAttributes(userGroup.id, 'SERVER_SCOPE', ['assetId'])\r\n                    .subscribe((result) => {\r\n                        userGroup.assetId = result[0].value;\r\n                        results.push(userGroup);\r\n                    });\r\n            }\r\n        });\r\n        return results;\r\n    }\r\n\r\n    function getEntityInfo() {\r\n        const currentUserId = currentUser.id;\r\n        const t = new PageLink(10000, 0, \"Tableau de bord - Clients (Prod)\", null);\r\n        widgetContext.rxjs.forkJoin([\r\n            entityGroupService.getEntityGroupsByOwnerId(currentOwnerInfo.type, currentOwnerInfo.id, \"USER\"),\r\n            dashboardService.getUserDashboards(currentUserId, null, t)\r\n        ]).subscribe((results) => {\r\n            const clientsUserGroupsInfo = getClientsUserGroups(results[0]);\r\n            const dashboardClientInfo = results[1].data[0]\r\n            vm.userGroupsList = clientsUserGroupsInfo;\r\n            vm.dashboardClientInfo = dashboardClientInfo;\r\n            vm.addEntityFormGroup.patchValue({\r\n                selectedUserGroups: vm.selectedUserGroups,\r\n                userGroupsList: vm.userGroupsList\r\n            });\r\n        });\r\n    }\r\n\r\n    getEntityInfo();\r\n\r\n    // ************************************* CREER UN UTILISATEUR *************************************\r\n\r\n    function addUserAttributes(user) {\r\n        const attributesArray = [ \r\n            { key: 'Téléphone', value: vm.addEntityFormGroup.get('userPhoneNumber').value },\r\n            { key: 'Date de création', value:  new Date().valueOf() },\r\n            { key: 'Date d\\'expiration', value: new Date().setFullYear(new Date().getFullYear() + 1) }\r\n        ];\r\n        return attributeService.saveEntityAttributes(user.id, 'SERVER_SCOPE', attributesArray);\r\n    }\r\n\r\n    function addUserToUserGroups(user, userGroups) {\r\n        let tasks = [];\r\n        userGroups.forEach(userGroup => {\r\n            tasks.push(entityGroupService.addEntityToEntityGroup(userGroup.id.id, user.id.id));\r\n        });\r\n        if(tasks.length > 0) {\r\n            return widgetContext.rxjs.forkJoin(tasks);\r\n        } else {\r\n            return widgetContext.rxjs.of([]);\r\n        }\r\n    }\r\n\r\n    function createUserRelations(user, userGroups) {\r\n        let tasks = [];\r\n        userGroups.forEach(userGroup => {\r\n            const newRelation = { \"from\": {\"entityType\": \"ASSET\", \"id\": userGroup.assetId}, \"to\": {\"entityType\": \"USER\", \"id\": user.id.id}, \"type\": \"Manages\", \"typeGroup\": \"COMMON\" };\r\n            tasks.push(entityRelationService.saveRelation(newRelation));\r\n        });\r\n        if(tasks.length > 0) {\r\n            return widgetContext.rxjs.forkJoin(tasks);\r\n        } else {\r\n            return widgetContext.rxjs.of([]);\r\n        }\r\n    }\r\n\r\n    function createUser(){\r\n        const defaultDashboardInfo = vm.dashboardClientInfo;\r\n        const user = {\r\n            \"additionalInfo\": {\r\n                \"description\": \"\",\r\n                \"defaultDashboardFullscreen\": true,\r\n                \"defaultDashboardId\": defaultDashboardInfo.id.id\r\n            },\r\n            \"authority\": currentUser.authority,\r\n            \"customerId\": {\r\n                \"entityType\": \"CUSTOMER\",\r\n                \"id\": currentUser.customerId\r\n            },\r\n            \"email\": vm.addEntityFormGroup.get('userEmail').value,\r\n            \"firstName\": vm.addEntityFormGroup.get('userFirstName').value,\r\n            \"lastName\": vm.addEntityFormGroup.get('userLastName').value,\r\n            \"name\": vm.addEntityFormGroup.get('userEmail').value,\r\n            \"ownerId\": {\r\n                \"entityType\": currentOwnerInfo.type,\r\n                \"id\": currentOwnerInfo.id\r\n            },\r\n            \"tenantId\": {\r\n                \"entityType\": \"TENANT\",\r\n                \"id\": currentUser.tenantId\r\n            }\r\n        };\r\n        return userService.saveUser(user, true);\r\n    }\r\n\r\n    // ************************************* ACTUALISER ET FERMER *************************************\r\n\r\n    function end(){\r\n        vm.addEntityFormGroup.markAsPristine();\r\n        widgetContext.updateAliases();\r\n        vm.dialogRef.close(null);\r\n    }\r\n\r\n    // ************************************* SUBMIT *************************************\r\n\r\n    vm.save = function() {\r\n        const userGroups = vm.addEntityFormGroup.get('selectedUserGroups').value;\r\n        createUser()\r\n            .subscribe((user) => {\r\n                widgetContext.rxjs.forkJoin([\r\n                    addUserToUserGroups(user, userGroups),\r\n                    addUserAttributes(user),\r\n                    createUserRelations(user, userGroups)\r\n                ]).subscribe((results) => { end() });\r\n            });\r\n    };\r\n}",
            "customResources": [
              {
                "url": "https://unpkg.com/axios@0.21.4/dist/axios.min.js"
              }
            ],
            "id": "cfc90b20-d36b-6e18-9ef3-7e5e1c772385"
          }
        ]
      },
      "showTitleIcon": false,
      "iconColor": "rgba(0, 0, 0, 0.87)",
      "iconSize": "24px",
      "titleTooltip": "",
      "enableFullscreen": false,
      "enableDataExport": true,
      "widgetStyle": {},
      "titleStyle": {
        "fontSize": "16px",
        "fontWeight": 400
      },
      "showLegend": false
    },
    "row": 0,
    "col": 0,
    "id": "4787e658-cc4d-5de1-7058-9c02c7f07d39"
  },
  "aliasesInfo": {
    "datasourceAliases": {},
    "targetDeviceAliases": {}
  },
  "filtersInfo": {
    "datasourceFilters": {}
  },
  "originalSize": {
    "sizeX": 8,
    "sizeY": 3
  },
  "originalColumns": 24
}